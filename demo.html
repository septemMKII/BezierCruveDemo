<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>

</head>
<body>
<canvas id="demo"  width="800" height="600"></canvas>
<script src="./jquery-3.1.0.min.js"></script>
<script src="./bezier.js"></script>
<script>
    (function() {
        var guides = [];
        var points = [];

        var $canvas = $( "#demo" ),
            canvas = $canvas[ 0 ],
            context = canvas.getContext( "2d" );

        var activePoint, mouseMove, mouseDown, mouseUp, foundPoint, foundGuidePointIndex, moving = false;

        mouseMove = function ( e ) {
            e.preventDefault();
            var x, y, found = false, guidesFound = false;

            fix( e );
            x = e.offsetX; y = e.offsetY;
            activePoint = {
                x: x,
                y: y,
                isBezier: false
            };

            points.forEach( function( d ) {
                if ( Math.abs( x - d.x ) < 10 && Math.abs( y - d.y ) < 10 ) {
                    found = found || true;
                }
            } );

            guides.forEach( function( d ) {
                if ( Math.abs( x - d.x ) < 10 && Math.abs( y - d.y ) < 10 ) {
                    guidesFound = guidesFound || true;
                }
            } );

            canvas.style.cursor = found || guidesFound ? "pointer" : "default";

            if ( moving && foundGuidePointIndex !== -1) {

                var diffX, diffY, changeGuides;

                if ( foundGuidePointIndex === 1 ) {

                    diffX = guides[ 1 ].x - x;
                    diffY = guides[ 1 ].y - y;

                    changeGuides = guides[ 0 ];

                    guides[ 1 ] = {
                        x: x,
                        y: y
                    };
                    guides[ 0 ] = {
                        x: changeGuides.x + diffX,
                        y: changeGuides.y + diffY
                    }
                } else {
                    diffX = x - guides[ 0 ].x;
                    diffY = y - guides[ 0 ].y;

                    changeGuides = guides[ 1 ];

                    guides[ 0 ] = {
                        x: x,
                        y: y
                    };

                    guides[ 1 ] = {
                        x: changeGuides.x - diffX,
                        y: changeGuides.y - diffY
                    };
                }
            }

            if ( points.length > 0 ) draw( activePoint );
        };

        mouseUp = function ( e ) {
            e.preventDefault();
            if(!moving) return;
            moving = false;
            foundGuidePointIndex = -1;
        };

        mouseDown = function ( e ) {
            e.preventDefault();
            var x, y, found = false, guidesFound = false;

            if ( e.which === 3 ) {
                return false;
            }

            fix( e );
            x = e.offsetX; y = e.offsetY;

            points.forEach( function( d, index ) {
                if ( Math.abs( x - d.x ) < 10 && Math.abs( y - d.y ) < 10 ) {
                    found = found || true;
                    moving = true;
                    if ( points[ index - 1 ] && points[ index + 1 ] ) foundPoint = d;
                }
            } );

            guides.forEach( function( d , index ) {
                if ( Math.abs( x - d.x ) < 10 && Math.abs( y - d.y ) < 10 ) {
                    guidesFound = guidesFound || true;
                    moving = true;
                    foundGuidePointIndex = index;
                }
            } );

            if ( found ) {
                if ( foundPoint ) {
                    foundPoint.isBezier = true;
                } else {
                    console.log( 'default trigger ' );
                }
            } else if ( guidesFound ) {

            } else {
                points.push({
                    x: x,
                    y: y,
                    isBezier: false
                });
            }

            draw();
        };

        function draw( activePoint ) {
            context.canvas.width = context.canvas.width;
            drawCurveGuides();
            points.forEach(function( d , index ) {
                if (points[ index + 1 ]) {
                    drawLine( d, points[ index + 1 ] );
                } else if ( activePoint ) {
                    drawLine( d, activePoint );
                }

                drawPoint( d );
            });
        }

        function drawCurveGuides () {

            if ( foundPoint && guides.length === 0 ) {
                console.log('0');
                var index = points.indexOf( foundPoint );
                var frontPoint = points[ index - 1 ];
                var afterPoint = points[ index + 1 ];

                var moveToPosition = {
                    x: frontPoint.x + (( foundPoint.x - frontPoint.x) / 2 ),
                    y: foundPoint.y
                };

                var lineToPosition = {
                    x: afterPoint.x - (( afterPoint.x - foundPoint.x ) / 2 ),
                    y: foundPoint.y
                };

                guides = [ moveToPosition , lineToPosition ];
            }

            if ( guides.length === 2 ) {

                console.log(JSON.stringify(guides[0]),JSON.stringify(guides[1]));

                drawLine.apply( this, guides );

                guides.forEach( function( d ) {
                    drawPoint( d );
                } );
            }
        }

        function drawLine( p1, p2 ) {
            context.beginPath();
            context.moveTo( p1.x, p1.y );
            context.lineTo( p2.x, p2.y );
            context.lineWidth = 2;
            context.stroke();
        }

        function drawPoint( d ) {
            context.beginPath();
            // Points
            context.moveTo( d.x + 8, d.y );
            context.arc( d.x, d.y, 8, 2 * Math.PI, 0, true );
            context.fillStyle = "rgb(255,255,255)";
            context.strokeStyle = 'rgb(255,20,20,0)';
            context.lineWidth = 2;
            context.fill();
            context.stroke();
        }

        var fix = function( e ) {
            e = e || window.event;
            if( !e.offsetX ) {
                e.offsetX = ( e.pageX - $( e.target ).offset().left );
                e.offsetY = ( e.pageY - $( e.target ).offset().top );
            }
        };

        $canvas.on( 'mousedown', mouseDown );
        $canvas.on( 'mouseup', mouseUp );
        $canvas.on( 'mousemove', mouseMove );
    })( window );
</script>
</body>
</html>