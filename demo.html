<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>

</head>
<body>
<canvas id="demo"  width="800" height="600"></canvas>
<script src="./jquery-3.1.0.min.js"></script>
<script src="./bezier.js"></script>
<script>
    (function() {
        var guides = [];
        var points = [];

        var $canvas = $( "#demo" ),
            canvas = $canvas[ 0 ],
            context = canvas.getContext( "2d" );

        var activePoint, mouseMove, mouseDown, foundPoint;

        mouseMove = function ( e ) {
            e.preventDefault();
            var x, y, found = false;

            fix( e );
            x = e.offsetX; y = e.offsetY;
            activePoint = {
                x: x,
                y: y,
                isBezier: false
            };

            points.forEach( function( d ) {
                if ( Math.abs( x - d.x ) < 10 && Math.abs( y - d.y ) < 10 ) {
                    found = found || true;
                }
            } );

            canvas.style.cursor = found ? "pointer" : "default";

            if ( points.length > 0 ) {
                if ( found ) {
                    draw()
                } else {
                    draw( activePoint );
                }
            }
        };

        mouseDown = function ( e ) {
            e.preventDefault();
            var x, y, found = false;

            if ( e.which === 3 ) {
                return false;
            }

            fix( e );
            x = e.offsetX; y = e.offsetY;

            points.forEach( function( d, index ) {
                if ( Math.abs( x - d.x ) < 10 && Math.abs( y - d.y ) < 10 ) {
                    found = found || true;
                    if ( points[ index - 1 ] && points[ index + 1 ] ) foundPoint = d;
                }
            } );

            if ( found ) {
                if ( foundPoint ) {
                    foundPoint.isBezier = true;
                } else {
                    console.log( 'default trigger ' );
                }
            } else {
                points.push({
                    x: x,
                    y: y,
                    isBezier: false
                });
            }

            draw();
        };

        function draw( activePoint ) {
            context.canvas.width = context.canvas.width;
            if ( foundPoint ) drawCurveGuides( foundPoint );
            points.forEach(function( d , index ) {
                var frontPoint = points[ index - 1 ];
                var afterPoint = points[ index + 1 ];

                var controlPoint;
                if ( afterPoint && afterPoint.isBezier ) {
                    controlPoint = guides[0];
                    drawBezierCurve( new Bezier(afterPoint.x,afterPoint.y ,controlPoint.x,controlPoint.y ,d.x,d.y) )
                } else if ( frontPoint && frontPoint.isBezier ) {
                    controlPoint = guides[1];
                    drawBezierCurve( new Bezier(d.x,d.y ,controlPoint.x,controlPoint.y ,frontPoint.x,frontPoint.y) )
                } else if ( !d.isBezier ) {
                    if ( afterPoint ) {
                        drawLine( d, afterPoint );
                    }
                }
            });

            if ( activePoint ) {
                drawLine( points[ points.length - 1 ], activePoint );
            }

            points.forEach( function( d ) {
                drawPoint( d );
            });
        }

        function drawCurveGuides ( foundPoint ) {
            var index = points.indexOf( foundPoint );
            var frontPoint = points[ index - 1 ];
            var afterPoint = points[ index + 1 ];

            var moveToPosition = {
                x: frontPoint.x + (( foundPoint.x - frontPoint.x) / 2 ),
                y: foundPoint.y
            };

            var lineToPosition = {
                x: afterPoint.x - (( afterPoint.x - foundPoint.x ) / 2 ),
                y: foundPoint.y
            };

            guides = [ moveToPosition , lineToPosition ];

            drawLine.apply( this, guides );

            guides.forEach( function( d ) {
                drawPoint( d );
            } );
        }

        function drawBezierCurve( curve ) {
            context.beginPath();
            var p = curve.points;
            context.moveTo( p[ 0 ].x, p[ 0 ].y );
            context.quadraticCurveTo(
                    p[ 1 ].x, p[ 1 ].y,
                    p[ 2 ].x, p[ 2 ].y
            );
            context.stroke();
        }

        function drawLine( p1, p2 ) {
            context.beginPath();
            context.moveTo( p1.x, p1.y );
            context.lineTo( p2.x, p2.y );
            context.lineWidth = 2;
            context.stroke();
        }

        function drawPoint( d ) {
            context.beginPath();
            // Points
            context.moveTo( d.x + 3, d.y );
            context.arc( d.x, d.y, 3, 2 * Math.PI, 0, true );
            context.fillStyle = "rgb(255,255,255)";
            context.strokeStyle = 'rgb(255,20,20,0)';
            context.lineWidth = 2;
            context.fill();
            context.stroke();
        }

        var fix = function( e ) {
            e = e || window.event;
            if( !e.offsetX ) {
                e.offsetX = ( e.pageX - $( e.target ).offset().left );
                e.offsetY = ( e.pageY - $( e.target ).offset().top );
            }
        };

        $canvas.on( 'mousedown', mouseDown );
        $canvas.on( 'mousemove', mouseMove );
    })( window );
</script>
</body>
</html>